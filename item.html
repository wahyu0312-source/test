<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>工程タイムライン | 品質管理生産技術</title>
<style>
  :root{ --bg1:#eef2ff; --bg2:#f8fafc; --card:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb; --accent:#2563eb; --shadow:0 30px 60px rgba(15,23,42,.08); --radius:22px; }
  *{box-sizing:border-box}
  body{ margin:0; color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif;
        background: radial-gradient(1200px 600px at -10% -10%, #c7d2fe 0%, transparent 60%), radial-gradient(900px 500px at 110% 0%, #bae6fd 0%, transparent 55%), linear-gradient(120deg,var(--bg1),var(--bg2));
        padding-bottom:64px; }
  header{position:sticky;top:0;z-index:10;background:#ffffffcc;backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
  .wrap{max-width:1100px;margin:0 auto;padding:12px 20px}
  .row{display:flex;justify-content:space-between;align-items:center;gap:16px}
  nav a{margin-right:16px;color:var(--accent);font-weight:700;text-decoration:none}
  nav a:hover{text-decoration:underline}
  main{max-width:1100px;margin:28px auto;padding:0 20px}
  .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  .title{display:flex;justify-content:space-between;align-items:center;gap:12px;margin:0 0 8px}
  .muted{color:var(--muted)} .small{font-size:12px}
  .btn{height:36px;padding:0 12px;border:1px solid var(--border);border-radius:12px;background:#fff;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-weight:700}
  .grid{display:grid;gap:12px}
  .grid.two{grid-template-columns: 1fr 1fr}
  @media (max-width: 860px){ .grid.two{grid-template-columns: 1fr} }
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{background:#f8fafc;color:#475569;text-align:left;font-weight:700;padding:10px 12px;border-bottom:1px solid var(--border)}
  tbody td{padding:10px 12px;border-bottom:1px solid var(--border);white-space:nowrap}
  /* Timeline */
  .tl{position:relative;padding-left:26px}
  .tl::before{content:"";position:absolute;left:12px;top:0;bottom:0;width:2px;background:#e2e8f0}
  .tli{position:relative;margin:14px 0;padding-left:6px}
  .tli::before{content:"";position:absolute;left:-16px;top:6px;width:10px;height:10px;border-radius:999px;background:#2563eb}
  .tli .ts{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; font-size:12px; color:#475569}
  .badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;font-weight:800;font-size:12px;color:#fff;background:#2563eb;margin-right:6px}
  .loc{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:#fff}
  .search{display:flex;gap:8px;flex-wrap:wrap}
  .search input{height:36px;padding:0 12px;border:1px solid var(--border);border-radius:12px}
  .footer{position:fixed;bottom:0;left:0;right:0;text-align:center;font-size:12px;color:#64748b;background:#f1f5f9;padding:4px 0}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <strong>工程タイムライン</strong>
    <nav>
      <a href="./index.html">← ダッシュボード</a>
    </nav>
  </div>
</header>

<main class="grid">
  <!-- Ringkas -->
  <section class="card">
    <div class="title">
      <h2 style="margin:0">アイテム概要</h2>
      <div class="search">
        <input id="idInput" placeholder="item_id / 図番 / 注番 を入力">
        <button id="btnGo" class="btn">表示</button>
        <button id="btnScan" class="btn">Scan</button>
      </div>
    </div>
    <div class="grid two">
      <div>
        <div class="pill" id="sumId">ID: -</div>
        <div style="height:8px"></div>
        <div class="pill" id="sumEvent">最新イベント: -</div>
        <div style="height:8px"></div>
        <div class="pill" id="sumLoc">現在位置: -</div>
      </div>
      <div>
        <div class="pill" id="sumCount">ログ件数: 0</div>
        <div style="height:8px"></div>
        <div class="pill" id="sumLastTs">最終更新: -</div>
      </div>
    </div>
  </section>

  <!-- Timeline -->
  <section class="card">
    <div class="title">
      <h2 style="margin:0">タイムライン</h2>
      <span class="small muted" id="tlHint"></span>
    </div>
    <div class="tl" id="tl"></div>
  </section>

  <!-- Tabel log -->
  <section class="card" style="grid-column:1/-1">
    <div class="title">
      <h2 style="margin:0">ログ詳細</h2>
      <div>
        <button id="btnReload" class="btn">Reload</button>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th>ts</th><th>event</th><th>location</th><th>user</th><th>note</th>
        </tr>
      </thead>
      <tbody id="logBody"></tbody>
    </table>
  </section>
</main>

<div class="footer">Design by Wahyu</div>

<!-- ZXing (opsional scan di halaman ini) -->
<script src="https://unpkg.com/@zxing/browser@latest"></script>

<script>
  // ====== CONFIG (samakan dengan index.html) ======
  const SHEET_ID ="1lYl7oYk6atnm3KqC6VwufARX3ooRyJ2VmC_xYFb4-OE";
  const LOG_TAB  ="scan_log";
  const LOG_CSV  =`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(LOG_TAB)}`;

  // Endpoint Apps Script kamu (supaya bisa scan dan append dari halaman ini juga)
  const LOG_API   ="https://script.google.com/macros/s/AKfycbxbStGHwWil46OzgINGXf8QyDQnylqao171zUsQyoHLrNjveLpZoc2NSBaEUsBkgCjL/exec";
  const LOG_TOKEN ="optional-or-same-as-server";
  const CURRENT_USER = "Wahyu";

  // ====== Utils ======
  const S = s => String(s ?? '').trim();
  function parseCSV(t){
    const rows=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g;
    let m, row=[]; t=t.replace(/\r\n?/g,"\n");
    for(let i=0;i<t.length;){
      re.lastIndex=i; m=re.exec(t); if(!m) break;
      let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
      row.push(cell); i=re.lastIndex;
      if(m[2]==="\n"||m[2]===""){ rows.push(row); row=[]; }
    }
    return rows.filter(r=>r.length && r.some(c=>S(c)!==""));
  }
  const qs = new URLSearchParams(location.search);
  function setQS(id){ const q=new URLSearchParams(); if(id) q.set('id', id); history.replaceState(null, '', location.pathname + (id?`?${q}`:'')); }

  // ====== State ======
  let currentId = S(qs.get('id') || '');
  let codeReader = null;

  // ====== Fetch & Render ======
  async function loadAndRender(){
    if(!currentId){ document.getElementById('tlHint').textContent = 'IDを入力してください。'; return; }
    const url = LOG_CSV + "&_ts=" + Date.now();
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok){ document.getElementById('tlHint').textContent = '読み込み失敗'; return; }
    const text = await res.text();
    const data = parseCSV(text);
    if(data.length<2){ document.getElementById('tlHint').textContent = 'ログなし'; return; }

    const header = data[0].map(S);
    const idx = {
      ts: header.indexOf('ts'),
      item: header.indexOf('item_id'),
      ev: header.indexOf('event'),
      loc: header.indexOf('location'),
      user: header.indexOf('user'),
      note: header.indexOf('note'),
    };

    // Filter untuk item_id yang cocok (case sensitive by default)
    const rows = data.slice(1)
      .filter(r => S(r[idx.item]) === currentId)
      .map(r => ({
        ts: new Date(S(r[idx.ts]) || 0),
        ev: S(r[idx.ev]),
        loc: S(r[idx.loc]),
        user:S(r[idx.user]),
        note:S(r[idx.note])
      }))
      .sort((a,b)=> a.ts - b.ts);

    // Render ringkasan
    const sumId = document.getElementById('sumId');
    const sumEvent = document.getElementById('sumEvent');
    const sumLoc = document.getElementById('sumLoc');
    const sumCount = document.getElementById('sumCount');
    const sumLastTs = document.getElementById('sumLastTs');

    sumId.textContent = `ID: ${currentId}`;
    sumCount.textContent = `ログ件数: ${rows.length}`;
    if(rows.length){
      const last = rows[rows.length-1];
      sumEvent.textContent = `最新イベント: ${last.ev}`;
      sumLoc.textContent   = `現在位置: ${last.loc || '-'}`;
      sumLastTs.textContent= `最終更新: ${last.ts.toLocaleString()}`;
    }else{
      sumEvent.textContent = `最新イベント: -`;
      sumLoc.textContent   = `現在位置: -`;
      sumLastTs.textContent= `最終更新: -`;
    }

    // Timeline
    const tl = document.getElementById('tl');
    tl.innerHTML = '';
    if(!rows.length){
      document.getElementById('tlHint').textContent = 'このIDのログはありません。';
    }else{
      document.getElementById('tlHint').textContent = '';
      rows.forEach(r=>{
        tl.insertAdjacentHTML('beforeend', `
          <div class="tli">
            <div class="ts">${r.ts.toLocaleString()}</div>
            <div><span class="badge">${r.ev || '-'}</span> <span class="loc">LOC: ${r.loc || '-'}</span></div>
            <div class="small muted">by ${r.user || '-'} ${r.note?`｜${r.note}`:''}</div>
          </div>
        `);
      });
    }

    // Tabel
    const tb = document.getElementById('logBody');
    tb.innerHTML = '';
    rows.forEach(r=>{
      tb.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${r.ts.toLocaleString()}</td>
          <td>${r.ev}</td>
          <td>${r.loc || '-'}</td>
          <td>${r.user || '-'}</td>
          <td>${r.note || ''}</td>
        </tr>
      `);
    });
  }

  // ====== Scan untuk langsung ke ID &/atau log event baru ======
  async function openScanner(){
    // scanner sederhana: baca barcode → set input → prompt (opsional) kirim log
    if(!codeReader){ codeReader = new ZXingBrowser.BrowserMultiFormatReader(); }
    const devices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
    if(!devices?.length){ alert('カメラが見つかりません'); return; }
    const deviceId = devices[0].deviceId;

    const video = document.createElement('video');
    Object.assign(video.style, {width:'1px',height:'1px',position:'fixed',left:'-9999px',top:'-9999px',opacity:'0'});
    document.body.appendChild(video);

    await codeReader.decodeFromVideoDevice(deviceId, video, async (result, err, controls)=>{
      if(result){
        controls.stop();
        document.body.removeChild(video);
        const id = result.getText();
        // 1) Navigasi ke item
        document.getElementById('idInput').value = id;
        currentId = id; setQS(currentId);
        await loadAndRender();

        // 2) (opsional) langsung catat event singkat
        const ev = prompt('イベントを入力 (RECEIVE/WIP/QC/PACK/SHIP). Kosongkan jika tidak ingin log:','');
        if(ev){
          const loc = prompt('現在位置/工程名 (例: 倉庫A / 組立1 / 検査室)','');
          try{
            const payload = { token: LOG_TOKEN, item_id: id, event: ev, location: loc||'', user: CURRENT_USER, note:'' };
            const res = await fetch(LOG_API,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
            const j = await res.json().catch(()=>({ok:false,error:'Invalid JSON'}));
            if(j.ok){ await loadAndRender(); alert('記録しました ✅'); }
            else { alert('送信失敗: '+ (j.error || res.status)); }
          }catch(e){
            alert('送信エラー: ' + e.message);
          }
        }
      }
    });
  }

  // ====== Events ======
  document.getElementById('btnReload').addEventListener('click', loadAndRender);
  document.getElementById('btnGo').addEventListener('click', ()=>{
    const v = S(document.getElementById('idInput').value);
    if(!v) return;
    currentId = v; setQS(currentId); loadAndRender();
  });
  document.getElementById('btnScan').addEventListener('click', openScanner);

  // prefill dari QS
  if(currentId){ document.getElementById('idInput').value = currentId; }
  loadAndRender();
</script>
</body>
</html>
